// Exceptions used
function InvalidFileObject(e){this.error_msg=e}function AccessDenied(e){this.error_msg=e}var FileSystem=function(){me=this,me.root_dir=null,me.cwd="",me.loadFile=function(t){$.get(t,function(t){typeof t=="object"?json_data=t:json_data=$.parseJSON(t),me.root_dir=e(json_data,null)}).fail(function(e,t,n){console.log(n)})};var e=function(t,n){if(t.type=="directory"){var r={},i={type:"directory"};for(var s in t.files){var o=e(t.files[s],i);r[s]=o}return i.files=r,i.parent=n,t.hasOwnProperty("encrypted")?(i.encrypted=t.encrypted,i.password=t.password):i.encrypted=!1,i}return t.parent=n,t};me.loaded=function(e){me.isLoaded()?e():setTimeout(function(){me.loaded(e)},100)},me.isLoaded=function(){return me.root_dir!=null};var t=function(e){if(e.length>0){if(e[0]==="/")throw new AccessDenied("You do not have access to the root filesystem.");return e.length>1&&e.substring(0,2)==="~/"?e.substring(2):me.cwd+e}return e},n=function(e,t,i){if(t.encrypted&&!i)throw file_path=r(t),new AccessDenied(file_path+" is encrypted and cannot be accessed");if(e.length==1&&e[0]==""){if(t["type"]!="directory")throw new InvalidFileObject("Not a directory");return t}if(e.length==0)return t;if(e.length>0&&t.type!="directory")throw new InvalidFileObject("No such file or directory.");var s=e[0];if(s===".."){if(t.parent===null)throw new InvalidFileObject("No such file or directory.");return n(e.slice(1),t.parent,i)}if(s===".")return n(e.slice(1),t,i);if(s in t.files)return n(e.slice(1),t.files[s],i);throw new InvalidFileObject("No such file or directory.")};me.getFile=function(e,r){typeof r=="undefined"&&(r=!1);var i=t(e),s=i.split("/");return n(s,me.root_dir,r)},me.getFiles=function(e,t){var n=me.getFile(e);if(n.type==="directory"){if(t)return n.files;var r={};for(var i in n.files)i[0]!=="."&&(r[i]=n.files[i]);return r}var s={};return s[e]=n,s},me.getFileNames=function(e,t){var n=me.getFiles(e,t),r=Object.keys(n);r.sort();var i=r.map(function(e){return n[e].type==="directory"?e+"/":e});return i};var r=function(e){if(e.parent===null)return"";for(var t in e.parent.files)if(e.parent.files[t]===e){var n=e.type==="directory"?"/":"";return r(e.parent)+t+n}};me.changeDirectory=function(e){var t=me.getFile(e);if(t.type!=="directory")throw new InvalidFileObject("Not a directory.");me.cwd=r(t)},me.decryptFile=function(e,t){file=me.getFile(e,!0);if(file.encrypted&&file.password===t)file.encrypted=!1;else if(file.password!=t)throw new AccessDenied("Incorrect password for decryption")}};