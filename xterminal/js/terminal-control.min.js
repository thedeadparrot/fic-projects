// Useful constants to keep around
function xterminal(e,t){parsed_command=$.terminal.parseCommand(e);switch(parsed_command.name){case"help":help(t,parsed_command.args);break;case"cd":cd(t,parsed_command.args);break;case"ls":ls(t,parsed_command.args);break;case"cat":cat(t,parsed_command.args);break;case"view":view(t,parsed_command.args);break;case"play":play(t,parsed_command.args);break;case"decrypt":decrypt(t,parsed_command.args);break;case"":break;default:t.error(parsed_command.name+": Command not found.")}}function login(e,t,n){e===USER&&t==PASSWORD?n(!0):n(!1)}function complete_file(e){var t=e.split("/"),n=t.length,r="~/"+filesystem.cwd,i=e,s=!1;n>1&&(s=!0,i=t.pop(),path=t.join("/"),path.charAt(0)!="~"?r="~/"+filesystem.cwd+path:r=path+"/");var o=filesystem.getFileNames(r,!0);return o=o.filter(function(e){return e.substring(0,i.length)===i}),s&&(o=o.map(function(e){return path+"/"+e})),o}function tab_completion(e,t,n){try{var r=complete_file(t)}catch(i){e.error(i.error_msg)}n(r)}function exitTerm(e){window.location.href=OUTRO_URL}function displayFile(e,t){$.get(e,function(e){t.echo(e)}).fail(function(){console.log("failure retrieving "+file.src)})}function help(e,t){if(t.length>0){command=t[0];switch(command){case"ls":case"cd":case"cat":case"view":case"play":case"filenames":case"decrypt":case"exit":displayFile("data/help/"+command+".txt",e);break;default:e.error("Sorry, there is no help file for that.")}}else displayFile("data/help/general.txt",e)}function cd(e,t){t.length>0?directory_path=t[0]:directory_path="~/";try{filesystem.changeDirectory(directory_path),root_dir=filesystem.cwd===""?"~":"~/",e.set_prompt(BASE_PROMPT+root_dir+filesystem.cwd.slice(0,-1)+"$ ")}catch(n){e.error(n.error_msg)}}function ls(e,t){var n="~/"+filesystem.cwd,r=!1;t.length>0&&(t[0]=="-a"?(r=!0,n=t.length>1?t[1]:n):n=t[0]);try{var i=filesystem.getFileNames(n,r);for(var s=0;s<i.length;s++)e.echo(i[s])}catch(o){console.log(o),e.error(o.error_msg)}}function cat(e,t){for(var n=0;n<t.length;n++){var r=t[n];try{var i=filesystem.getFile(r);i.type==="text"?displayFile(i.src,e):e.error(r+": not a text file.")}catch(s){console.log(s),e.error(s.error_msg)}}}function view(e,t){if(t.length>0){var n=t[0];try{var r=filesystem.getFile(n);r.type==="image"?$.magnificPopup.open({items:{src:r.src},image:{titleSrc:function(e){return r.title}},type:"image",cursor:null}):e.error(n+": not an image and cannot be viewed")}catch(i){console.log(i),e.error(i.error_msg)}}else e.error("No image to view.")}function play(e,t){if(t.length>0){var n=t[0];try{var r=filesystem.getFile(n),i=$("<div>").addClass("media-container");if(r.type==="video"){var s=$("<video controls>"),o=$("<source>").attr("type",'video/webm;codecs="vp8"');o.attr("src",r.webm_src);var u=$("<source>").attr("type",'video/webm;codecs="vp8"');u.attr("src",r.mp4_src),s.append(o,u),i.append(s)}else if(r.type=="audio"){var a=$("<audio controls>");a.attr("src",r.src),i.append(a)}else e.error(n+": not video or audio and cannot be played.");$.magnificPopup.open({items:{src:i},type:"inline",closeBtnInside:!1})}catch(f){console.log(f),e.error(f.error_msg)}}else e.error("No video to play.")}GREETINGS_STRING="Welcome to Xavier's School for the Gifted \n____      ___ \n`MM(      )M' \n `MM.     d'  \n  `MM.   d'   \n   `MM. d'    \n    `MMd      \n     dMM.     \n    d'`MM.    \n   d'  `MM.   \n  d'    `MM.  \n_M(_    _)MM_ \n\nLast login: Mar 25 08:42:24 EST 2006 \n \nType 'help' for a list of available commands.\n",ROOT_DIR="~",USER="cxavier",PASSWORD="ivebeentothemountaintop",BASE_PROMPT=USER+"@xterminal:",OUTRO_URL="http://thedeadparrot.dreamwidth.org/545078.html",DATA_FILE="data/files.json";var filesystem=new FileSystem;filesystem.loadFile(DATA_FILE);var decrypt=function(e,t){if(t.length>0){var n=prompt("Enter the password to decrypt this file.");try{filesystem.decryptFile(t[0],n),e.echo(t[0]+" has been decrypted.")}catch(r){console.log(r),e.error(r.error_msg)}}else e.error("No file or directory to decrypt")};$(document).ready(function(){filesystem.loaded(function(){$("body").terminal(xterminal,{login:login,greetings:GREETINGS_STRING,name:"xterm",prompt:BASE_PROMPT+ROOT_DIR+"$ ",onExit:exitTerm,tabcompletion:!0,completion:tab_completion})})});